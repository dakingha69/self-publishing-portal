import {Session} from 'meteor/session';

import * as ContractCollectionHelper from '/client/lib/helpers/contractCollectionHelper';
import {pendingTransaction} from '/client/lib/helpers/ethereumHelper';
import {
    insertPendingTransaction,
    removePendingTransaction,
    failedTransaction
} from '/client/lib/helpers/transactionCollectionHelper';

const abiArray = [{
    "constant": true,
    "inputs": [],
    "name": "creator",
    "outputs": [{"name": "", "type": "address"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "valueType",
    "outputs": [{"name": "", "type": "uint8"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "name",
    "outputs": [{"name": "", "type": "string"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "reward",
    "outputs": [{"name": "", "type": "uint256"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "isAccepted",
    "outputs": [{"name": "", "type": "bool"}],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "acceptContract",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "description",
    "outputs": [{"name": "", "type": "string"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "contractPartner",
    "outputs": [{"name": "", "type": "address"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "isFullfilled",
    "outputs": [{"name": "", "type": "bool"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [{"name": "", "type": "uint256"}],
    "name": "contractTypes",
    "outputs": [{"name": "", "type": "uint8"}],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "declineContract",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "inputs": [{"name": "name", "type": "string"}, {
        "name": "description",
        "type": "string"
    }, {"name": "contractPartner", "type": "address"}, {"name": "reward", "type": "uint256"}, {
        "name": "valueTypeId",
        "type": "uint256"
    }, {"name": "contractTypeIds", "type": "uint256[]"}], "payable": false, "type": "constructor"
}, {
    "anonymous": false,
    "inputs": [{"indexed": false, "name": "creator", "type": "address"}, {
        "indexed": false,
        "name": "partner",
        "type": "address"
    }, {"indexed": false, "name": "contractAddress", "type": "address"}],
    "name": "ContractAccepted",
    "type": "event"
}, {
    "anonymous": false,
    "inputs": [{"indexed": false, "name": "creator", "type": "address"}, {
        "indexed": false,
        "name": "partner",
        "type": "address"
    }, {"indexed": false, "name": "contractAddress", "type": "address"}],
    "name": "ContractDeclined",
    "type": "event"
}];

IndividualContractContract = web3.eth.contract(abiArray);

export function createIndividualContract(name, description, contractPartner, reward, valueTypeId, contractTypeIds, cb) {
    Session.set('waitingForConfirmation', true);
    IndividualContractContract.new(name, description, contractPartner, reward, valueTypeId, contractTypeIds,
        {
            from: web3.eth.accounts[0],
            data: '0x60606040527307f95f32da24404537aa5952379c8ca436a2bd50600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c010000000000000000000000009081020402179055503462000000576040516200132c3803806200132c833981016040528080518201919060200180518201919060200180519060200190919080519060200190919080519060200190919080518201919060200150505b85955084945033600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c010000000000000000000000009081020402179055508393506000600860006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055506000600860016101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055506200018b826200029c6401000000000262000845176401000000009004565b620001aa816200040d64010000000002620009b1176401000000009004565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630aa2121b338630604051847c0100000000000000000000000000000000000000000000000000000000028152600401808473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1681526020019350505050600060405180830381600087803b15620000005760325a03f11562000000575050505b505050505050620006c7565b6000811415620002e5576000600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b60018114156200032e576001600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b600281141562000377576002600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b6003811415620003c0576003600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b600481141562000409576004600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b5b50565b600060006007805460008255601f0160209004906000526020600020908101906200045291905b808211156200044e57600081600090555060010162000434565b5090565b5b50600091505b8251821015620006c1578282815181101562000000579060200190602002015190506001811415620005385760078054806001018281815481835581811511620004e057601f016020900481601f01602090048360005260206000209182019101620004df91905b80821115620004db576000816000905550600101620004c1565b5090565b5b50505091600052602060002090602091828204019190065b6000909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550505b6002811415620005f557600780548060010182818154818355818115116200059d57601f016020900481601f016020900483600052602060002091820191016200059c91905b80821115620005985760008160009055506001016200057e565b5090565b5b50505091600052602060002090602091828204019190065b6001909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550505b6003811415620006b257600780548060010182818154818355818115116200065a57601f016020900481601f016020900483600052602060002091820191016200065991905b80821115620006555760008160009055506001016200063b565b5090565b5b50505091600052602060002090602091828204019190065b6002909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550505b5b818060010192505062000459565b5b505050565b610c5680620006d66000396000f3606060405236156100a7576000357c01000000000000000000000000000000000000000000000000000000009004806302d05d3f146100ac57806305bbbea3146100e557806306fdde0314610110578063228cb7331461018b5780635051a5ec146101ae578063619d2671146101d35780637284e416146101e2578063800fa5ff1461025d5780639db9109e14610296578063e99548a5146102bb578063ef23b813146102f4575b610000565b34610000576100b9610303565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576100f2610329565b60405180826004811161000057815260200191505060405180910390f35b346100005761011d61033c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561017d5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576101986103da565b6040518082815260200191505060405180910390f35b34610000576101bb6103e0565b60405180821515815260200191505060405180910390f35b34610000576101e06103f3565b005b34610000576101ef6105b7565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561024f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761026a610655565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576102a361067b565b60405180821515815260200191505060405180910390f35b34610000576102d6600480803590602001909190505061068e565b60405180826003811161000057815260200191505060405180910390f35b34610000576103016106bf565b005b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600660009054906101000a900460ff1681565b60018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103d25780601f106103a7576101008083540402835291602001916103d2565b820191906000526020600020905b8154815290600101906020018083116103b557829003601f168201915b505050505081565b60055481565b600860009054906101000a900460ff1681565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614158061049e5750600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614155b156104a857610000565b6001600860006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055507f377e6f023fbebfa25069d0eebfe9a18486442bf446eb7a8ba2a319d0443c8f3f600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1630604051808473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff168152602001935050505060405180910390a15b5b565b60028054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561064d5780601f106106225761010080835404028352916020019161064d565b820191906000526020600020905b81548152906001019060200180831161063057829003601f168201915b505050505081565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600860019054906101000a900460ff1681565b60078181548110156100005790600052602060002090602091828204019190065b915054906101000a900460ff1681565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614158061076a5750600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614155b1561077457610000565b7f35bd287cec5c2d4ec96c59f4d1789ee1fa2b4e43c9375c5e1ad839bbe042232d600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1630604051808473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff168152602001935050505060405180910390a15b5b565b600081141561088d576000600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b60018114156108d5576001600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b600281141561091d576002600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b6003811415610965576003600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b60048114156109ad576004600660006101000a81548160ff02191690837f01000000000000000000000000000000000000000000000000000000000000009081020402179055505b5b50565b600060006007805460008255601f0160209004906000526020600020908101906109f391905b808211156109ef5760008160009055506001016109d7565b5090565b5b50600091505b8251821015610c505782828151811015610000579060200190602002015190506001811415610ad25760078054806001018281815481835581811511610a7a57601f016020900481601f01602090048360005260206000209182019101610a7991905b80821115610a75576000816000905550600101610a5d565b5090565b5b50505091600052602060002090602091828204019190065b6000909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550505b6002811415610b8a5760078054806001018281815481835581811511610b3257601f016020900481601f01602090048360005260206000209182019101610b3191905b80821115610b2d576000816000905550600101610b15565b5090565b5b50505091600052602060002090602091828204019190065b6001909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550505b6003811415610c425760078054806001018281815481835581811511610bea57601f016020900481601f01602090048360005260206000209182019101610be991905b80821115610be5576000816000905550600101610bcd565b5090565b5b50505091600052602060002090602091828204019190065b6002909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550505b5b81806001019250506109fa565b5b50505056',
            gas: '4700000'
        }, (error, contract) => {
            Session.set('waitingForConfirmation', false);
            if (error) {
                console.error(error);
                Materialize.toast('You have to accept the transaction', 3000);
            }
            else {
                const createIndividualContractTx = {
                    type: 'Contract',
                    title: 'New contract created',
                    description: 'You created a new contract'
                };
                insertPendingTransaction(contract.transactionHash, createIndividualContractTx);
                if (cb) cb();
                if (typeof contract.address !== 'undefined') {
                    console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                    removePendingTransaction(contract.transactionHash);
                }
            }
        }
    );
}